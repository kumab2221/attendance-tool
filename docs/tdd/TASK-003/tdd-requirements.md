# TASK-003: CLIインターフェース基盤 - 詳細要件定義

## 概要

勤怠管理ツールのコマンドラインインターフェース（CLI）を実装する。
Clickライブラリを使用して直感的で使いやすいCLIを構築し、ファイル処理、期間指定、進捗表示機能を提供する。

## 機能要件

### 1. メインコマンド

```bash
attendance-tool [OPTIONS] COMMAND [ARGS]...
```

#### 基本コマンド構造
- **process**: 勤怠データの処理・集計
- **config**: 設定管理
- **validate**: データ検証
- **version**: バージョン情報表示

### 2. processコマンド

#### 2.1 基本形式
```bash
attendance-tool process --input INPUT_FILE --output OUTPUT_PATH [OPTIONS]
```

#### 2.2 必須オプション
- `--input`, `-i`: 入力CSVファイルパス
  - 型: Path
  - バリデーション: ファイル存在チェック、CSV拡張子チェック
  - 例: `data/attendance.csv`

- `--output`, `-o`: 出力パス（ファイル/ディレクトリ）
  - 型: Path
  - バリデーション: 書き込み権限チェック
  - 例: `output/report.csv`, `output/`

#### 2.3 期間指定オプション（排他的）
- `--month`, `-m`: 月単位指定
  - 型: String
  - フォーマット: YYYY-MM
  - 例: `2024-03`
  - バリデーション: 日付フォーマット、過去1年〜未来1ヶ月の範囲

- `--start-date`, `-s` + `--end-date`, `-e`: 期間範囲指定
  - 型: String
  - フォーマット: YYYY-MM-DD
  - 例: `--start-date 2024-03-01 --end-date 2024-03-31`
  - バリデーション: 開始日 ≤ 終了日、妥当な日付範囲

- `--year`, `-y`: 年単位指定
  - 型: Integer
  - 例: `2024`
  - バリデーション: 2020-2030の範囲

#### 2.4 出力形式オプション
- `--format`, `-f`: 出力形式
  - 選択肢: `csv`, `excel`, `both`
  - デフォルト: `csv`
  - 複数指定可能

- `--report-type`, `-r`: レポート種類
  - 選択肢: `employee`, `department`, `daily`, `all`
  - デフォルト: `employee`
  - 複数指定可能

#### 2.5 処理オプション
- `--config-dir`: 設定ディレクトリパス
  - 型: Path
  - デフォルト: `config/`
  - バリデーション: ディレクトリ存在チェック

- `--verbose`, `-v`: 詳細ログ出力
  - カウント: `-v`, `-vv`, `-vvv`
  - レベル: INFO, DEBUG, TRACE

- `--quiet`, `-q`: 静寂モード
  - 進捗表示を抑制
  - エラーのみ出力

- `--dry-run`: ドライラン
  - 実際の処理は行わず検証のみ
  - 処理内容の確認用

#### 2.6 パフォーマンスオプション
- `--chunk-size`: チャンク処理サイズ
  - 型: Integer
  - デフォルト: 1000
  - 大容量ファイル対応

- `--parallel`: 並列処理
  - 型: Boolean
  - デフォルト: False
  - 複数CPU利用

### 3. configコマンド

#### 3.1 設定表示
```bash
attendance-tool config show [SECTION]
```

#### 3.2 設定検証
```bash
attendance-tool config validate
```

### 4. validateコマンド

#### 4.1 データ検証
```bash
attendance-tool validate --input INPUT_FILE [OPTIONS]
```

### 5. versionコマンド

#### 5.1 バージョン情報
```bash
attendance-tool version [--detailed]
```

## 非機能要件

### 1. ユーザビリティ

#### 1.1 ヘルプメッセージ
- 各コマンド・オプションに詳細な説明
- 使用例の提供
- エラーメッセージは具体的で理解しやすく

#### 1.2 進捗表示
- プログレスバー表示（tqdm使用）
- 処理段階の明示（読み込み、検証、集計、出力）
- 処理時間の表示
- ファイルサイズ、レコード数の表示

#### 1.3 対話的確認
- 上書き確認
- 大量データ処理の確認
- 設定変更の確認

### 2. パフォーマンス

#### 2.1 応答性
- コマンド起動時間: < 1秒
- ヘルプ表示: < 0.5秒
- バリデーション: < 2秒

#### 2.2 メモリ効率
- チャンク処理によるメモリ使用量制御
- 大容量ファイル対応（>100MB）

### 3. 堅牢性

#### 3.1 エラーハンドリング
- 適切なエラーメッセージ
- 終了コード（0=成功、1=エラー、2=警告）
- ログファイルへの詳細情報出力

#### 3.2 入力検証
- ファイルパス存在チェック
- 日付フォーマット検証
- 数値範囲チェック
- 権限チェック

## 受け入れ基準

### 1. 基本機能
- [ ] メインコマンドが正常に起動する
- [ ] ヘルプメッセージが適切に表示される
- [ ] バージョン情報が表示される

### 2. processコマンド
- [ ] 必須引数の指定で処理が実行される
- [ ] 各期間指定オプションが機能する
- [ ] 出力形式オプションが機能する
- [ ] 進捗表示が機能する

### 3. エラーハンドリング
- [ ] 不正な引数でエラーメッセージが表示される
- [ ] 存在しないファイルでエラーが発生する
- [ ] 不正な日付形式でエラーが発生する
- [ ] 権限不足でエラーが発生する

### 4. バリデーション
- [ ] ファイルパス検証が機能する
- [ ] 日付範囲検証が機能する
- [ ] オプション組み合わせ検証が機能する

### 5. ユーザビリティ
- [ ] プログレスバーが表示される
- [ ] 処理時間が表示される
- [ ] 適切な確認メッセージが表示される

## 実装技術仕様

### 1. ライブラリ
- **Click**: CLIフレームワーク
- **tqdm**: プログレスバー
- **pathlib**: パス操作
- **datetime**: 日付処理

### 2. ファイル構成
```
src/attendance_tool/cli/
├── __init__.py
├── main.py          # メインエントリーポイント
├── commands.py      # コマンド定義
├── options.py       # 共通オプション定義
├── validators.py    # 入力検証
├── progress.py      # 進捗表示
└── utils.py         # CLI用ユーティリティ
```

### 3. エントリーポイント
- `pyproject.toml`で`attendance-tool`コマンドを定義
- `attendance_tool.cli:main`関数をエントリーポイントに設定

### 4. 設定統合
- `attendance_tool.utils.config`モジュールとの統合
- 環境変数による設定オーバーライド対応
- ログ設定の適用

### 5. エラー処理
- カスタム例外クラスの定義
- 統一されたエラーハンドリング
- 適切な終了コードの返却

## テスト要件

### 1. 単体テスト
- コマンド引数パース
- バリデーション機能
- オプション処理
- エラーハンドリング

### 2. 統合テスト
- 実際のCLI実行
- ファイル入出力
- 設定ファイル連携

### 3. エンドツーエンドテスト
- 完全なワークフロー
- 様々なオプション組み合わせ
- エラーシナリオ

## セキュリティ考慮事項

### 1. ファイルアクセス
- パストラバーサル攻撃の防止
- 適切な権限チェック
- 一時ファイルの安全な処理

### 2. 入力検証
- インジェクション攻撃の防止
- ファイルサイズ制限
- メモリ使用量制限

## 実装優先順位

### Phase 1: 基本構造
1. メインコマンド構造
2. processコマンド基本形
3. 必須オプション処理

### Phase 2: 期間指定
1. 月単位指定
2. 期間範囲指定
3. 年単位指定

### Phase 3: 出力制御
1. 出力形式選択
2. レポート種類選択
3. 進捗表示

### Phase 4: 高度な機能
1. 設定管理コマンド
2. データ検証コマンド
3. パフォーマンス最適化

### Phase 5: 拡張機能
1. 対話的モード
2. 設定ウィザード
3. プラグイン機能