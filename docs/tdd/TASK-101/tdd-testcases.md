# TASK-101: CSVファイル読み込み・検証機能 - テストケース設計

## テストケース概要

TASK-101のCSVファイル読み込み・検証機能に対する包括的なテストケース設計。
正常系、異常系、境界値テストケースを網羅し、高品質なソフトウェアを保証する。

## テストケース分類

### 1. 正常系テストケース (Happy Path)

#### TC-101-001: 標準的なCSVファイル読み込み

**目的**: 標準的なUTF-8, カンマ区切りCSVファイルが正常に読み込めることを確認

**テストデータ**:
```csv
社員ID,氏名,部署,日付,出勤時刻,退勤時刻,休憩時間
E001,田中太郎,営業部,2024-01-15,09:00,18:00,60
E002,佐藤花子,経理部,2024-01-15,08:30,17:30,60
E003,鈴木次郎,技術部,2024-01-15,10:00,19:00,60
```

**期待結果**:
- ファイルが正常に読み込まれる
- 全行（3行）が処理される
- カラムマッピングが適切に実行される
- データ型変換が正しく実行される
- ValidationResult.is_valid = True

**検証項目**:
- [x] 読み込み完了ステータス
- [x] 行数の一致
- [x] カラム名のマッピング
- [x] データ型の正確性
- [x] 処理時間（3秒以内）

#### TC-101-002: 異なるエンコーディングファイル読み込み

**目的**: UTF-8-sig, Shift_JIS等の異なるエンコーディングファイルが読み込めることを確認

**テストデータ**:
- UTF-8-sig版（BOM付き）
- Shift_JIS版
- CP932版

**期待結果**:
- エンコーディングが自動検出される
- 日本語文字が正しく処理される
- 文字化けが発生しない

**検証項目**:
- [x] エンコーディング検出の正確性
- [x] 日本語文字の正確な読み込み
- [x] BOM処理の適切性

#### TC-101-003: 異なる区切り文字ファイル読み込み

**目的**: カンマ、タブ、セミコロン区切りファイルが読み込めることを確認

**テストデータ**:
- タブ区切り（TSV）
- セミコロン区切り
- パイプ区切り

**期待結果**:
- 区切り文字が自動判定される
- データが正しく分割される
- カラム数が一致する

**検証項目**:
- [x] 区切り文字の自動判定
- [x] データ分割の正確性
- [x] カラム構造の維持

#### TC-101-004: 多様な日付・時刻フォーマット処理

**目的**: 異なる日付・時刻フォーマットが統一形式に変換されることを確認

**テストデータ**:
```csv
社員ID,日付,出勤時刻,退勤時刻
E001,2024/01/15,9:00,18:00
E002,01/15/2024,09:00:00,18:00:00
E003,2024-01-15,9:00 AM,6:00 PM
```

**期待結果**:
- 全ての日付がYYYY-MM-DD形式に統一される
- 全ての時刻がHH:MM形式に統一される
- AM/PM表記が24時間制に変換される

**検証項目**:
- [x] 日付フォーマット統一
- [x] 時刻フォーマット統一
- [x] AM/PM変換の正確性

#### TC-101-005: カラム名の柔軟マッチング

**目的**: 様々なカラム名パターンが適切にマッピングされることを確認

**テストデータ**:
```csv
EMP_ID,Employee_Name,DEPT,Work_Date,Start_Time,End_Time
E001,田中太郎,営業部,2024-01-15,09:00,18:00
```

**期待結果**:
- EMP_ID → employee_id へマッピング
- Employee_Name → employee_name へマッピング
- DEPT → department へマッピング
- 大文字小文字の違いが無視される

**検証項目**:
- [x] カラム名マッチングの柔軟性
- [x] 大文字小文字の無視
- [x] マッピング結果の記録

### 2. 異常系テストケース (Error Cases)

#### TC-101-101: ファイル不存在エラー (EDGE-001)

**目的**: 存在しないファイルを指定した場合の適切なエラーハンドリングを確認

**テスト実行**:
```python
reader = CSVReader()
result = reader.load_file("/nonexistent/path/file.csv")
```

**期待結果**:
- FileNotFoundError例外が発生
- 明確なエラーメッセージが表示
- ファイルパスが含まれるエラー情報
- 終了コード: 非0

**検証項目**:
- [x] 適切な例外の発生
- [x] エラーメッセージの内容
- [x] ログ出力の記録
- [x] 例外情報の詳細度

#### TC-101-102: 権限不足エラー

**目的**: アクセス権限がないファイルに対する適切な処理を確認

**テスト実行**:
- 読み取り権限のないファイルを作成
- ファイル読み込みを実行

**期待結果**:
- PermissionError例外が発生
- 権限問題を示すエラーメッセージ
- 解決方法のヒント提供

**検証項目**:
- [x] 権限エラーの検出
- [x] ユーザーフレンドリーなメッセージ
- [x] 解決策の提示

#### TC-101-103: 空ファイルエラー (EDGE-106)

**目的**: 空ファイル（0バイト）の適切な処理を確認

**テストデータ**:
- 0バイトファイル
- ヘッダーのみファイル
- 空行のみファイル

**期待結果**:
- 適切なエラーまたは警告
- 空ファイル状態の通知
- サンプルフォーマットの提示

**検証項目**:
- [x] 空ファイルの検出
- [x] 適切な通知レベル
- [x] ユーザーガイダンス

#### TC-101-104: 文字化けエラー (EDGE-205)

**目的**: エンコーディング問題による文字化けの検出と対応を確認

**テストデータ**:
- 不正なエンコーディングファイル
- バイナリファイル
- 混在エンコーディングファイル

**期待結果**:
- エンコーディングエラーの検出
- 推奨エンコーディングの提示
- 文字化け箇所の特定

**検証項目**:
- [x] 文字化けの検出
- [x] エンコーディング候補の提示
- [x] エラー箇所の特定

#### TC-101-105: 不正CSVフォーマットエラー (REQ-202)

**目的**: CSVフォーマットが破損したファイルの処理を確認

**テストデータ**:
```csv
社員ID,氏名,部署
E001,田中太郎,営業部
E002,"未完了クォート,経理部
E003,佐藤花子,"営業部
```

**期待結果**:
- フォーマットエラーの検出
- 問題行の特定
- 期待フォーマットの説明

**検証項目**:
- [x] フォーマット破損の検出
- [x] エラー行番号の報告
- [x] 修正提案の提供

#### TC-101-106: 必須カラム不足エラー

**目的**: 必須カラムが不足した場合の処理を確認

**テストデータ**:
```csv
氏名,部署,日付
田中太郎,営業部,2024-01-15
```

**期待結果**:
- 必須カラム不足エラー
- 不足しているカラム名のリスト
- 必要なフォーマットの説明

**検証項目**:
- [x] 必須カラムチェック
- [x] 不足カラムの特定
- [x] フォーマット仕様の提示

#### TC-101-107: データ型変換エラー

**目的**: データ型変換に失敗した場合の処理を確認

**テストデータ**:
```csv
社員ID,氏名,日付,出勤時刻,退勤時刻
E001,田中太郎,無効な日付,25:00,abc
```

**期待結果**:
- データ型エラーの検出
- エラー箇所の詳細情報
- 期待される形式の説明

**検証項目**:
- [x] データ型検証
- [x] エラーデータの特定
- [x] 正しい形式の案内

### 3. 境界値テストケース (Boundary Tests)

#### TC-101-201: 最大ファイルサイズ処理

**目的**: 大容量ファイル（10,000件）の処理性能を確認

**テストデータ**:
- 10,000行のCSVファイル
- 各行に完全な勤怠データ
- ファイルサイズ約5MB

**期待結果**:
- 5分以内での処理完了
- メモリ使用量1GB以下
- プログレス表示の更新
- 全データの正確な処理

**検証項目**:
- [x] 処理時間の測定
- [x] メモリ使用量の監視
- [x] プログレス表示の動作
- [x] データ整合性の確認

#### TC-101-202: 最小ファイルサイズ処理

**目的**: 最小構成ファイル（ヘッダー+1行）の処理を確認

**テストデータ**:
```csv
社員ID,氏名,日付
E001,田中太郎,2024-01-15
```

**期待結果**:
- 正常な処理完了
- 1件のデータとして認識
- 必要最小限の情報で動作

**検証項目**:
- [x] 最小データセットの処理
- [x] 必須情報の充足確認
- [x] エラーの非発生

#### TC-101-203: 極端な日付値処理

**目的**: 境界的な日付値の処理を確認

**テストデータ**:
- 過去5年の境界日（2019-01-01）
- 未来日（明日以降）
- うるう年の2月29日
- 存在しない日付（2月30日）

**期待結果**:
- 有効範囲内の日付は処理される
- 範囲外の日付は警告される
- 無効な日付はエラーとなる

**検証項目**:
- [x] 日付範囲の検証
- [x] 無効日付の検出
- [x] うるう年の正確な処理

#### TC-101-204: 極端な時刻値処理

**目的**: 境界的な時刻値の処理を確認

**テストデータ**:
- 00:00（深夜0時）
- 23:59（深夜11時59分）
- 24:00（翌日0時の表記）
- 25:00（無効時刻）

**期待結果**:
- 有効な時刻は正しく処理される
- 24:00は00:00に変換される
- 無効時刻はエラーとなる

**検証項目**:
- [x] 時刻境界値の処理
- [x] 24:00形式の変換
- [x] 無効時刻の検出

#### TC-101-205: 最大勤務時間処理

**目的**: 24時間を超える勤務時間の検出を確認

**テストデータ**:
```csv
社員ID,氏名,日付,出勤時刻,退勤時刻
E001,田中太郎,2024-01-15,09:00,08:00
E002,佐藤花子,2024-01-15,00:00,23:59
```

**期待結果**:
- 24時間超勤務が検出される
- 適切な警告メッセージ
- データは保持されるが警告フラグ

**検証項目**:
- [x] 長時間勤務の検出
- [x] 警告メッセージの内容
- [x] データ保持方針の確認

### 4. 統合テストケース (Integration Tests)

#### TC-101-301: 設定ファイル統合テスト

**目的**: csv_format.yamlの設定が正しく適用されることを確認

**テスト実行**:
- 設定ファイルの読み込み
- カラムマッピング設定の適用
- データ検証設定の適用

**期待結果**:
- 設定が正しく読み込まれる
- カラム名マッピングが動作
- 検証ルールが適用される

**検証項目**:
- [x] 設定ファイル読み込み
- [x] マッピング規則適用
- [x] 検証ルール適用

#### TC-101-302: ログシステム統合テスト

**目的**: ログ出力が正しく動作することを確認

**テスト実行**:
- 各処理段階でのログ出力
- エラー時のログ出力
- 個人情報マスキング

**期待結果**:
- 適切なレベルでログ出力
- エラー情報の記録
- 個人情報の適切なマスキング

**検証項目**:
- [x] ログレベルの適切性
- [x] ログ内容の詳細度
- [x] プライバシー保護

#### TC-101-303: CLI統合テスト

**目的**: CLIから呼び出した場合の動作を確認

**テスト実行**:
```bash
attendance-tool process --input test.csv --output output/ --verbose
```

**期待結果**:
- コマンドライン引数が正しく処理される
- プログレスバーが表示される
- 結果が適切に出力される

**検証項目**:
- [x] CLI引数の処理
- [x] プログレス表示
- [x] 出力結果の妥当性

### 5. パフォーマンステストケース

#### TC-101-401: 応答時間テスト

**目的**: 各ファイルサイズでの応答時間を測定

**テスト条件**:
- 100件: 3秒以内
- 1,000件: 10秒以内
- 10,000件: 5分以内

**検証項目**:
- [x] 処理時間の測定
- [x] スループットの確認
- [x] リソース使用量の監視

#### TC-101-402: メモリ効率テスト

**目的**: メモリ使用量の効率性を確認

**テスト条件**:
- チャンク読み込みの動作
- メモリ使用量の制限
- ガベージコレクションの効果

**検証項目**:
- [x] メモリ使用パターン
- [x] メモリリークの非発生
- [x] 効率的なデータ処理

### 6. セキュリティテストケース

#### TC-101-501: ファイルパス検証テスト

**目的**: パストラバーサル攻撃の防御を確認

**テストデータ**:
- "../../../etc/passwd"
- "..\\..\\windows\\system32\\config"
- "/dev/null"

**期待結果**:
- 不正パスが検出される
- セキュアなパス処理
- 適切なエラーメッセージ

**検証項目**:
- [x] パストラバーサル防止
- [x] 安全なファイル操作
- [x] 権限の適切な確認

#### TC-101-502: CSVインジェクション防止テスト

**目的**: CSVインジェクション攻撃の防御を確認

**テストデータ**:
```csv
社員ID,氏名,計算式
E001,=SUM(1+1),営業部
E002,@SUM(1+1),技術部
```

**期待結果**:
- 危険な数式が無害化される
- セキュリティ警告の発生
- 安全なデータ処理

**検証項目**:
- [x] 数式インジェクション防止
- [x] セキュリティ警告の発生
- [x] データサニタイゼーション

## テスト実装方針

### テストフレームワーク
- **pytest**: メインテストフレームワーク
- **pytest-cov**: テストカバレッジ測定
- **pytest-mock**: モックオブジェクト
- **pytest-benchmark**: パフォーマンステスト

### テストデータ管理
- **fixtures/csv/**: テスト用CSVファイル格納
- **動的生成**: 大容量ファイルは実行時生成
- **テンプレート**: 共通テストデータのテンプレート化

### テスト実行環境
- **単体テスト**: 開発環境での高速実行
- **統合テスト**: CI/CD環境での自動実行
- **パフォーマンステスト**: 専用環境での定期実行

### カバレッジ目標
- **行カバレッジ**: 90%以上
- **分岐カバレッジ**: 85%以上
- **関数カバレッジ**: 100%

## テスト自動化

### 継続的インテグレーション
- プルリクエスト時の自動テスト実行
- テスト失敗時の自動通知
- カバレッジレポートの生成

### テスト環境管理
- Docker化による環境統一
- 依存関係の明確化
- 再現可能なテスト実行

この包括的なテストケース設計により、TASK-101の機能が確実に動作し、高品質なソフトウェアとして提供されることを保証する。次のステップで、これらのテストケースを失敗する形で実装し、TDDのRed Phaseを実行する。