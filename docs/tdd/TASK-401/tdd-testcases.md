# TASK-401: エラーハンドリング統合 - テストケース設計

## 概要

統一されたエラーハンドリング機構のテストケースを設計する。正常系、異常系、境界値テストを包含し、すべてのアクセプタンスクライテリアを満たすことを確認する。

## テスト戦略

### テストレベル
- **単体テスト**: 個別クラス・メソッドの動作確認
- **統合テスト**: モジュール間の連携確認
- **シナリオテスト**: 実際のエラー発生時の動作確認

### テストカテゴリ
- **エラー分類テスト**: 各種エラーの正しい分類
- **リカバリーテスト**: 自動回復機能の動作
- **メッセージテスト**: ユーザーフレンドリーなメッセージ生成
- **ログテスト**: 適切なログ出力の確認
- **パフォーマンステスト**: エラーハンドリングのオーバーヘッド測定

## テストケース詳細

### 1. エラー分類・重要度判定テスト

#### TC-401-001: システムエラーの分類
**目的**: システムエラーが正しくSYS-XXXコードに分類されることを確認

**テストデータ**:
```python
test_cases = [
    {
        "exception": FileNotFoundError("/path/to/missing.csv"),
        "expected_category": "SYSTEM",
        "expected_code": "SYS-001",
        "expected_severity": "ERROR"
    },
    {
        "exception": PermissionError("Access denied"),
        "expected_category": "SYSTEM", 
        "expected_code": "SYS-004",
        "expected_severity": "CRITICAL"
    },
    {
        "exception": MemoryError("Out of memory"),
        "expected_category": "SYSTEM",
        "expected_code": "SYS-003", 
        "expected_severity": "CRITICAL"
    }
]
```

**期待結果**:
- 各例外が適切なカテゴリに分類される
- 正しいエラーコードが割り当てられる
- 適切な重要度が判定される

#### TC-401-002: データエラーの分類
**目的**: データ検証エラーが正しくDATA-XXXコードに分類されることを確認

**テストデータ**:
```python
test_cases = [
    {
        "exception": ValidationError("Invalid date format", field="date"),
        "expected_category": "DATA",
        "expected_code": "DATA-001",
        "expected_severity": "WARNING"
    },
    {
        "exception": TimeLogicError("Start time > End time"),
        "expected_category": "DATA",
        "expected_code": "DATA-201",
        "expected_severity": "ERROR"
    }
]
```

#### TC-401-003: ビジネスロジックエラーの分類
**目的**: 就業規則違反等がBIZ-XXXコードに分類されることを確認

**テストデータ**:
```python
test_cases = [
    {
        "exception": WorkHoursError("Work hours exceed 24h"),
        "expected_category": "BUSINESS",
        "expected_code": "BIZ-104",
        "expected_severity": "WARNING"
    }
]
```

### 2. リカバリー・部分継続処理テスト

#### TC-401-010: I/Oエラーリトライ機能
**目的**: 一時的なI/Oエラーがリトライされることを確認

**テストシナリオ**:
1. ファイル読み込み処理を実行
2. 1回目: IOException発生
3. 2回目: IOException発生  
4. 3回目: 正常処理

**期待結果**:
- 3回まで自動リトライされる
- 3回目で成功した場合、処理が継続される
- リトライ回数がログに記録される

#### TC-401-011: メモリ不足時の自動回復
**目的**: メモリ不足時にガベージコレクションが実行されることを確認

**テストシナリオ**:
1. 大量データ処理でメモリ不足を発生させる
2. MemoryErrorをキャッチ
3. ガベージコレクション実行
4. 処理継続を試行

**期待結果**:
- ガベージコレクションが自動実行される
- メモリが解放される
- 処理が継続される（可能な場合）

#### TC-401-012: 部分的データエラーでの継続処理
**目的**: 一部のデータにエラーがある場合も処理が継続されることを確認

**テストデータ**:
```csv
employee_id,date,start_time,end_time
001,2024-01-01,09:00,17:00
002,invalid-date,09:00,17:00  # エラー行
003,2024-01-01,09:00,17:00
```

**期待結果**:
- エラー行をスキップして処理継続
- 処理結果にエラーサマリーが含まれる
- 正常行のデータは正しく処理される

### 3. ユーザーフレンドリーメッセージテスト

#### TC-401-020: 日本語エラーメッセージ
**目的**: エラーメッセージが適切な日本語で表示されることを確認

**テストケース**:
```python
test_cases = [
    {
        "input": FileNotFoundError("/data/input.csv"),
        "expected_message": "ファイルが見つかりません\n詳細: /data/input.csvが存在しないか、アクセスできません\n解決方法: ファイルパスを確認し、ファイルが存在することを確認してください"
    },
    {
        "input": PermissionError("Access denied"),
        "expected_message": "ファイルへのアクセス権限がありません\n詳細: ファイルまたはフォルダへの読み書き権限がない可能性があります\n解決方法: 管理者権限で実行するか、ファイルの権限設定を確認してください"
    }
]
```

#### TC-401-021: 技術用語の平易な表現
**目的**: 技術用語が分かりやすく表現されることを確認

**テストケース**:
- `ValidationError` → "データの形式に問題があります"
- `MemoryError` → "メモリ不足により処理を継続できません"
- `TimeoutError` → "処理に時間がかかりすぎました"

#### TC-401-022: 解決方法の提案
**目的**: 具体的な解決方法が提示されることを確認

**期待結果**:
- 各エラーに対して具体的な対処法が表示される
- 実行可能な手順が含まれる
- 関連するヘルプ情報へのリンクが提供される

### 4. ログ出力テスト

#### TC-401-030: 構造化ログの出力
**目的**: エラー情報が構造化されたログに出力されることを確認

**期待ログフォーマット**:
```json
{
    "timestamp": "2024-01-01T10:30:00.000Z",
    "level": "ERROR",
    "category": "SYSTEM",
    "code": "SYS-001",
    "message": "ファイルが見つかりません",
    "details": {
        "file_path": "/data/input.csv",
        "operation": "csv_read",
        "user_id": "masked_***"
    },
    "stack_trace": "...",
    "recovery_attempted": true,
    "recovery_success": false
}
```

#### TC-401-031: 個人情報マスキング
**目的**: 個人情報が適切にマスキングされることを確認

**テストデータ**:
```python
test_cases = [
    {
        "input": "Employee 田中太郎 has invalid data",
        "expected": "Employee ****** has invalid data"
    },
    {
        "input": "email: tanaka@example.com failed",
        "expected": "email: ******@example.com failed"
    }
]
```

#### TC-401-032: ログレベル別出力
**目的**: ログレベルに応じて適切な出力先に記録されることを確認

**テストケース**:
- `CRITICAL`: コンソール + ファイル + システムログ
- `ERROR`: コンソール + ファイル
- `WARNING`: ファイルのみ
- `INFO`: デバッグモード時のみファイル

### 5. 統合テスト

#### TC-401-040: CLI統合テスト
**目的**: CLIからの実行時にエラーハンドリングが正しく動作することを確認

**テストシナリオ**:
1. 存在しないファイルを指定してCLI実行
2. 権限のないディレクトリを出力先に指定
3. 不正フォーマットのCSVファイルを指定

**期待結果**:
- 適切なエラーメッセージがコンソールに表示
- 終了コードが適切に設定される
- ログファイルにエラー詳細が記録される

#### TC-401-041: 既存モジュール統合
**目的**: 既存の各モジュールでエラーハンドリングが統一されることを確認

**テスト対象モジュール**:
- `csv_reader.py`
- `validator.py`
- `calculator.py`
- `excel_exporter.py`

**期待結果**:
- 各モジュールで統一されたエラーハンドリングパターン
- 一貫したエラーメッセージフォーマット
- 統一されたログ出力

### 6. パフォーマンステスト

#### TC-401-050: エラーハンドリングオーバーヘッド
**目的**: エラーハンドリング処理のオーバーヘッドが5%以内であることを確認

**テスト方法**:
1. エラーハンドリング無効時の処理時間を測定
2. エラーハンドリング有効時の処理時間を測定
3. オーバーヘッドを計算

**期待結果**: オーバーヘッド ≤ 5%

#### TC-401-051: 非同期ログ出力性能
**目的**: ログ出力が処理性能に与える影響を最小化することを確認

**テスト条件**:
- 1000件のエラーログを連続出力
- 処理時間とメモリ使用量を測定

**期待結果**:
- ログ出力による処理ブロックが発生しない
- メモリ使用量が適切に制御される

### 7. エラーシナリオテスト

#### TC-401-060: ファイル不存在 (EDGE-001)
**シナリオ**: 指定されたCSVファイルが存在しない

**期待動作**:
1. FileNotFoundErrorをキャッチ
2. SYS-001エラーコードを割り当て
3. 分かりやすいメッセージを表示
4. 処理を適切に終了

#### TC-401-061: ディスク容量不足 (EDGE-002)
**シナリオ**: 出力ファイル作成時にディスク容量不足

**期待動作**:
1. OSErrorをキャッチ
2. SYS-002エラーコードを割り当て
3. 容量確保の方法を提案
4. 他の出力先を提案

#### TC-401-062: メモリ不足 (EDGE-003)
**シナリオ**: 大量データ処理時にメモリ不足

**期待動作**:
1. MemoryErrorをキャッチ
2. ガベージコレクション実行
3. チャンク処理に切り替え
4. 処理継続を試行

#### TC-401-063: 権限不足 (EDGE-004)
**シナリオ**: ファイル読み書き権限不足

**期待動作**:
1. PermissionErrorをキャッチ
2. SYS-004エラーコードを割り当て
3. 権限設定方法を説明
4. 管理者権限での実行を提案

#### TC-401-064: ネットワークエラー (EDGE-005)
**シナリオ**: ネットワークファイルアクセス時のエラー

**期待動作**:
1. NetworkErrorをキャッチ
2. SYS-005エラーコードを割り当て
3. ネットワーク状況確認を提案
4. ローカルファイル使用を提案

## テスト実行計画

### フェーズ1: 単体テスト
- 各例外クラスのテスト
- エラーハンドラーのロジックテスト
- メッセージフォーマッターテスト

### フェーズ2: 統合テスト
- 既存モジュールとの統合確認
- CLI統合テスト
- パフォーマンステスト

### フェーズ3: シナリオテスト
- 実際のエラーシナリオでのエンドツーエンドテスト
- ユーザビリティテスト
- ロバストネステスト

## 成功基準

### 機能面
- [ ] 全テストケースがパス
- [ ] エラー分類精度100%
- [ ] リカバリー成功率80%以上

### 品質面  
- [ ] コードカバレッジ95%以上
- [ ] パフォーマンスオーバーヘッド5%以内
- [ ] ユーザビリティスコア85%以上

### 運用面
- [ ] ログ出力の構造化率100%
- [ ] 個人情報マスキング精度100%
- [ ] 監査要件充足率100%