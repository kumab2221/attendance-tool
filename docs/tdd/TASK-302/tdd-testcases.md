# TASK-302: Excelレポート出力 - テストケース設計

## 概要

Excel形式でのレポート出力機能に対する包括的なテストケースを定義する。正常系、異常系、境界値テストを含み、品質の高いExcel出力機能を保証する。

## テストカテゴリー

### 1. 正常系テスト（Happy Path）

#### T302-001: 基本Excel出力機能
**目的**: 標準的な勤怠データでのExcel出力正常動作を検証

**前提条件**:
- 5名の社員の1か月分勤怠データ
- 3部門の部門別集計データ
- 出力ディレクトリが存在

**実行手順**:
1. ExcelExporterインスタンスを作成
2. `export_excel_report()`を呼び出し
3. 生成されたExcelファイルを検証

**期待結果**:
- ファイル名: `attendance_report_2024_01.xlsx`
- 3つのワークシート作成: 社員別, 部門別, サマリー
- ExportResult.success = True
- ファイルサイズ > 0

#### T302-002: 社員別ワークシート検証
**目的**: 社員別ワークシートの構造と内容を検証

**前提条件**:
- 10名の社員データ（完全な勤怠記録）

**検証項目**:
- ワークシート名: "社員別レポート"
- ヘッダー行: 13カラム（社員ID, 氏名, 部署, 対象年月, 出勤日数, 欠勤日数, 遅刻回数, 早退回数, 総労働時間, 所定労働時間, 残業時間, 深夜労働時間, 有給取得日数）
- データ行: 10行
- セル書式:
  - ヘッダー: 太字、背景色あり
  - 数値列: 適切な小数点桁数
  - 自動幅調整適用

#### T302-003: 部門別ワークシート検証
**目的**: 部門別ワークシートの構造と条件付き書式を検証

**前提条件**:
- 5部門のデータ（出勤率90%, 95%, 88%, 97%, 92%）

**検証項目**:
- ワークシート名: "部門別レポート"
- ヘッダー行: 8カラム
- 条件付き書式:
  - 97%部門: 緑色背景
  - 95%, 92%部門: 黄色背景
  - 88%部門: 赤色背景

#### T302-004: サマリーワークシート検証
**目的**: サマリーワークシートの集計値とグラフを検証

**前提条件**:
- 社員別・部門別データが存在

**検証項目**:
- 総従業員数の正確性
- 平均出勤率の計算精度
- 部門別出勤率棒グラフの存在
- 集計値の一貫性（社員別データとの整合性）

#### T302-005: Excel固有機能検証
**目的**: Excel特有の機能が正常に設定されることを検証

**検証項目**:
- 自動フィルター設定（ヘッダー行）
- ウィンドウ枠固定（ヘッダー行）
- 印刷設定（A4最適化）
- 罫線設定（全セル薄いグレー）

### 2. 異常系テスト（Error Cases）

#### T302-E001: 空データ処理
**目的**: データが存在しない場合の適切な処理を検証

**テストケース**:
- 社員データが空リスト
- 部門データが空リスト
- 両方が空リスト

**期待結果**:
- Excelファイル生成成功
- ヘッダーのみのワークシート作成
- ExportResult.success = True
- 適切な警告メッセージ

#### T302-E002: ファイル権限エラー
**目的**: 出力先への書き込み権限がない場合の処理を検証

**前提条件**:
- 出力ディレクトリの書き込み権限を削除

**期待結果**:
- ExportResult.success = False
- エラーメッセージ: "Permission denied"
- 例外が適切にキャッチされる

#### T302-E003: 不正データ処理
**目的**: データに異常値が含まれる場合の処理を検証

**テストケース**:
- 社員ID が None
- 部門名が空文字列
- 数値フィールドが負の値
- 文字列フィールドが数値

**期待結果**:
- ファイル生成継続（部分的成功）
- デフォルト値での代替
- 警告メッセージの記録

#### T302-E004: メモリ不足シミュレーション
**目的**: 大容量データ処理時のメモリ不足対応を検証

**前提条件**:
- 非常に大きなデータセット（10,000名分）

**期待結果**:
- 適切なエラーメッセージ
- 部分的なデータ保存（可能な範囲で）
- プロセスがクラッシュしない

#### T302-E005: 無効な出力パス
**目的**: 存在しないディレクトリやファイルパスでの処理を検証

**テストケース**:
- 存在しないドライブ (`Z:\nonexistent\`)
- 不正な文字を含むパス
- 長すぎるファイルパス（OS制限超過）

**期待結果**:
- ExportResult.success = False
- 適切なエラーメッセージ
- アプリケーションの継続動作

### 3. 境界値テスト（Boundary Tests）

#### T302-B001: 最大データ量処理
**目的**: Excelの行数制限に近いデータでの処理を検証

**前提条件**:
- 1,048,576行に近いデータ（Excel制限）

**期待結果**:
- 制限内: 正常処理
- 制限超過: 適切なエラーメッセージ
- パフォーマンス基準内（60秒以内）

#### T302-B002: メモリ使用量境界
**目的**: メモリ使用量が制限値に近い場合の処理を検証

**前提条件**:
- メモリ使用量が1GB近くに達するデータサイズ

**期待結果**:
- メモリ使用量 ≤ 1GB
- ガベージコレクション適切実行
- 処理完了またはクリーンなエラー

#### T302-B003: ファイルサイズ境界
**目的**: 大容量Excelファイル生成時の処理を検証

**前提条件**:
- 生成ファイルが20MB近くになるデータ

**期待結果**:
- ファイル生成成功
- ファイル破損なし
- 適切な圧縮率

#### T302-B004: 特殊文字処理境界
**目的**: Unicode文字や特殊記号を含むデータの処理を検証

**テストデータ**:
- 社員名: "田中 太郎", "Smith, John", "佐藤★花子", "山田\t次郎"
- 部門名: "営業部", "R&D", "総務/人事", "🏢 本社"

**期待結果**:
- 全文字が正確に表示
- Excel内検索機能が正常動作
- ファイル破損なし

#### T302-B005: 日付境界値処理
**目的**: 特殊な日付（うるう年、月末等）での処理を検証

**テストケース**:
- 2024年2月29日（うるう年）
- 2023年2月28日（平年）
- 2024年12月31日（年末）
- 2025年1月1日（年始）

**期待結果**:
- 全日付が正確にフォーマット
- 期間計算が正確
- Excel日付機能との互換性

### 4. 統合テスト（Integration Tests）

#### T302-I001: CSV出力との併用
**目的**: CSV出力機能と同時使用時の動作を検証

**前提条件**:
- CSV出力とExcel出力を同一データで実行

**検証項目**:
- 両ファイルのデータ一貫性
- 処理時間の合理性
- リソース競合なし

#### T302-I002: 設定ファイル統合
**目的**: 設定ファイルからのExcel設定読み込みを検証

**前提条件**:
- config/excel_format.yaml に設定を定義

**検証項目**:
- カスタム設定の適用
- デフォルト設定へのフォールバック
- 設定エラー時の適切な処理

#### T302-I003: エンドツーエンド統合
**目的**: CLI → データ処理 → Excel出力の全体フローを検証

**前提条件**:
- 実際のCSVファイル
- コマンドライン実行

**検証項目**:
- 全処理フローの正常動作
- プログレスバー表示
- 最終出力ファイルの品質

### 5. パフォーマンステスト（Performance Tests）

#### T302-P001: 処理時間測定
**目的**: 各種データサイズでの処理時間を測定

**測定ケース**:
- 10名 × 1か月: < 5秒
- 100名 × 1か月: < 10秒
- 1,000名 × 1か月: < 60秒

**測定項目**:
- ワークシート作成時間
- セル書式設定時間
- ファイル保存時間

#### T302-P002: メモリ使用量測定
**目的**: メモリ使用パターンの分析

**測定項目**:
- 最大メモリ使用量
- メモリリーク検出
- ガベージコレクション効率

#### T302-P003: 並行処理性能
**目的**: 複数Excel出力の同時実行性能を検証

**前提条件**:
- 3つの異なる期間データで同時出力

**期待結果**:
- デッドロックなし
- 各処理の独立性確保
- 合理的な処理時間

### 6. 互換性テスト（Compatibility Tests）

#### T302-C001: Excel互換性検証
**目的**: 様々なExcelバージョンでの動作確認

**テスト対象**:
- Microsoft Excel 2016, 2019, 2021, 365
- LibreOffice Calc 7.x
- Google Sheets（インポート）

**検証項目**:
- ファイルオープン成功
- レイアウト保持
- 書式適用状況
- グラフ表示状況

#### T302-C002: OS互換性検証
**目的**: 異なるOS環境での動作確認

**テスト環境**:
- Windows 10/11
- macOS (Monterey以降)
- Linux (Ubuntu 20.04+)

**検証項目**:
- ファイル生成成功
- 文字エンコーディング
- パス区切り文字処理

### 7. セキュリティテスト（Security Tests）

#### T302-S001: 個人情報保護
**目的**: Excel出力時の個人情報保護機能を検証

**テストケース**:
- マスキング対象フィールドの確認
- ログ出力での個人情報漏洩防止
- 一時ファイルの安全な削除

#### T302-S002: ファイル権限設定
**目的**: 生成されるExcelファイルの適切な権限設定を検証

**検証項目**:
- 読み取り専用権限の適用
- 不正アクセス防止
- ファイル暗号化（オプション）

## テストデータ定義

### 標準テストデータセット
```python
STANDARD_EMPLOYEE_DATA = [
    AttendanceSummary(
        employee_id="EMP001",
        employee_name="田中太郎",
        department="営業部",
        attendance_days=22,
        business_days=22,
        tardiness_count=1,
        early_leave_count=0,
        total_work_minutes=10560,  # 176時間
        scheduled_overtime_minutes=960,  # 16時間
        legal_overtime_minutes=0,
        paid_leave_days=2.0
    ),
    # ... 他の社員データ
]

STANDARD_DEPARTMENT_DATA = [
    DepartmentSummary(
        department_name="営業部",
        employee_count=10,
        total_work_minutes=105600,
        total_overtime_minutes=9600,
        attendance_rate=95.5,
        average_work_minutes=528
    ),
    # ... 他の部門データ
]
```

### 異常データセット
```python
EDGE_CASE_DATA = [
    # None値を含むデータ
    AttendanceSummary(employee_id=None, employee_name="", department=None, ...),
    # 極端な値を含むデータ
    AttendanceSummary(attendance_days=0, total_work_minutes=0, ...),
    # 特殊文字を含むデータ
    AttendanceSummary(employee_name="山田\t太郎★", department="R&D/AI", ...),
]
```

## テスト実行環境

### 必要な依存関係
```
openpyxl>=3.1.0
pandas>=1.5.0
pytest>=7.0.0
pytest-cov>=4.0.0
pytest-mock>=3.10.0
memory-profiler>=0.60.0
```

### テストファイル構成
```
tests/unit/output/
├── test_excel_exporter.py          # ExcelExporter単体テスト
├── test_excel_config.py            # Excel設定テスト
├── test_excel_formatting.py        # 書式設定テスト
├── test_excel_charts.py            # グラフ機能テスト
└── fixtures/
    ├── excel_test_data.py          # テストデータ定義
    └── expected_outputs/
        └── sample_excel_report.xlsx # 期待結果比較用
```

### テスト実行コマンド
```bash
# 全テスト実行
pytest tests/unit/output/test_excel_exporter.py -v

# カバレッジ付き実行
pytest tests/unit/output/test_excel_exporter.py --cov=src/attendance_tool/output --cov-report=html

# 特定テストケース実行
pytest tests/unit/output/test_excel_exporter.py::TestExcelExporter::test_export_basic_excel_file -v

# パフォーマンステスト実行
pytest tests/unit/output/test_excel_exporter.py -k "performance" --durations=0
```

## 成功基準

### 必須テスト
- [ ] T302-001〜T302-005: 全正常系テスト通過
- [ ] T302-E001〜T302-E005: 全異常系テスト通過
- [ ] T302-B001〜T302-B005: 全境界値テスト通過

### 品質基準
- [ ] テストカバレッジ ≥ 95%
- [ ] 全テストケース通過率 = 100%
- [ ] パフォーマンステスト基準達成

### 統合基準
- [ ] CSV出力機能との整合性確認
- [ ] エンドツーエンド動作確認
- [ ] 実際のExcelアプリケーションでのファイル確認

## 備考

### テスト優先順位
1. **高**: 正常系テスト（T302-001〜005）
2. **高**: 主要異常系テスト（T302-E001〜003）
3. **中**: 境界値テスト（T302-B001〜005）
4. **中**: パフォーマンステスト（T302-P001〜003）
5. **低**: 互換性テスト（T302-C001〜002）

### 継続的改善
- テスト実行時間の最適化
- テストデータの自動生成機能
- 回帰テストの自動実行環境構築